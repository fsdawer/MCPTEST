name: Auto PR (develop â†’ main)

on:
  push:
    branches: [develop]

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        run: |
          PR_EXISTS=$(gh pr list --base main --head develop --state open --json number --jq 'length')
          echo "exists=$PR_EXISTS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create PR
        if: steps.check-pr.outputs.exists == '0'
        run: |
          gh pr create \
            --base main \
            --head develop \
            --title "ğŸš€ develop â†’ main ë™ê¸°í™”" \
            --body "## ìë™ ìƒì„±ëœ PR

            develop ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ main ë¸Œëœì¹˜ì— ë¨¸ì§€í•©ë‹ˆë‹¤.

            ### í¬í•¨ëœ ì»¤ë°‹
            $(git log main..develop --oneline | head -20)

            ---
            ğŸ¤– ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing PR
        if: steps.check-pr.outputs.exists != '0'
        run: |
          PR_NUMBER=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number')
          gh pr edit $PR_NUMBER \
            --body "## ìë™ ìƒì„±ëœ PR (ì—…ë°ì´íŠ¸ë¨)

            develop ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ main ë¸Œëœì¹˜ì— ë¨¸ì§€í•©ë‹ˆë‹¤.

            ### í¬í•¨ëœ ì»¤ë°‹
            $(git log main..develop --oneline | head -20)

            ---
            ğŸ¤– ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤
            ğŸ“… ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: $(date '+%Y-%m-%d %H:%M:%S')"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
