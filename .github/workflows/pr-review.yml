name: PR Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41

      - name: PR Stats Comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const stats = {
              additions: 0,
              deletions: 0,
              changes: 0,
              files: files.length
            };

            const fileTypes = {};

            files.forEach(file => {
              stats.additions += file.additions;
              stats.deletions += file.deletions;
              stats.changes += file.changes;

              const ext = file.filename.split('.').pop() || 'other';
              fileTypes[ext] = (fileTypes[ext] || 0) + 1;
            });

            const fileTypeList = Object.entries(fileTypes)
              .map(([ext, count]) => `- \`.${ext}\`: ${count}Í∞ú`)
              .join('\n');

            const body = `## üìä PR Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏

            ### Î≥ÄÍ≤Ω ÌÜµÍ≥Ñ
            | Ìï≠Î™© | ÏàòÏπò |
            |------|------|
            | üìÅ Î≥ÄÍ≤ΩÎêú ÌååÏùº | ${stats.files}Í∞ú |
            | ‚ûï Ï∂îÍ∞ÄÎêú ÎùºÏù∏ | ${stats.additions}Ï§Ñ |
            | ‚ûñ ÏÇ≠Ï†úÎêú ÎùºÏù∏ | ${stats.deletions}Ï§Ñ |
            | üìù Ï¥ù Î≥ÄÍ≤Ω | ${stats.changes}Ï§Ñ |

            ### ÌååÏùº ÌÉÄÏûÖÎ≥Ñ Î≥ÄÍ≤Ω
            ${fileTypeList}

            ### Î≥ÄÍ≤ΩÎêú ÌååÏùº Î™©Î°ù
            ${files.map(f => {
              const status = f.status === 'added' ? 'üÜï' : f.status === 'removed' ? 'üóëÔ∏è' : '‚úèÔ∏è';
              return \`- ${status} \\\`${f.filename}\\\` (+${f.additions}/-${f.deletions})\`;
            }).join('\n')}

            ---
            ü§ñ *ÏûêÎèô ÏÉùÏÑ±Îêú Î¶¨Ìè¨Ìä∏ÏûÖÎãàÎã§*`;

            // Í∏∞Ï°¥ ÏΩîÎ©òÌä∏ Ï∞æÍ∏∞
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('PR Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  size-label:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Add size label
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const changes = pr.additions + pr.deletions;
            let sizeLabel = '';

            if (changes < 10) sizeLabel = 'size/XS';
            else if (changes < 50) sizeLabel = 'size/S';
            else if (changes < 200) sizeLabel = 'size/M';
            else if (changes < 500) sizeLabel = 'size/L';
            else sizeLabel = 'size/XL';

            // Í∏∞Ï°¥ size ÎùºÎ≤® Ï†úÍ±∞
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            for (const label of labels) {
              if (label.name.startsWith('size/')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label.name
                });
              }
            }

            // ÏÉà ÎùºÎ≤® Ï∂îÍ∞Ä
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [sizeLabel]
            });
