name: PR Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PR Stats Comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const stats = {
              additions: 0,
              deletions: 0,
              changes: 0,
              files: files.length
            };

            const fileTypes = {};

            files.forEach(file => {
              stats.additions += file.additions;
              stats.deletions += file.deletions;
              stats.changes += file.changes;

              const ext = file.filename.split('.').pop() || 'other';
              fileTypes[ext] = (fileTypes[ext] || 0) + 1;
            });

            const fileTypeList = Object.entries(fileTypes)
              .map(([ext, count]) => `- .${ext}: ${count}ê°œ`)
              .join('\n');

            const fileList = files.map(f => {
              let status = 'âœï¸';
              if (f.status === 'added') status = 'ðŸ†•';
              if (f.status === 'removed') status = 'ðŸ—‘ï¸';
              return `- ${status} ${f.filename} (+${f.additions}/-${f.deletions})`;
            }).join('\n');

            const body = `## ðŸ“Š PR ë¶„ì„ ë¦¬í¬íŠ¸

### ë³€ê²½ í†µê³„
| í•­ëª© | ìˆ˜ì¹˜ |
|------|------|
| ðŸ“ ë³€ê²½ëœ íŒŒì¼ | ${stats.files}ê°œ |
| âž• ì¶”ê°€ëœ ë¼ì¸ | ${stats.additions}ì¤„ |
| âž– ì‚­ì œëœ ë¼ì¸ | ${stats.deletions}ì¤„ |
| ðŸ“ ì´ ë³€ê²½ | ${stats.changes}ì¤„ |

### íŒŒì¼ íƒ€ìž…ë³„ ë³€ê²½
${fileTypeList}

### ë³€ê²½ëœ íŒŒì¼ ëª©ë¡
${fileList}

---
ðŸ¤– *ìžë™ ìƒì„±ëœ ë¦¬í¬íŠ¸ìž…ë‹ˆë‹¤*`;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('PR ë¶„ì„ ë¦¬í¬íŠ¸')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  size-label:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Add size label
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const changes = pr.additions + pr.deletions;
            let sizeLabel = 'size/XS';

            if (changes >= 500) sizeLabel = 'size/XL';
            else if (changes >= 200) sizeLabel = 'size/L';
            else if (changes >= 50) sizeLabel = 'size/M';
            else if (changes >= 10) sizeLabel = 'size/S';

            try {
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });

              for (const label of labels) {
                if (label.name.startsWith('size/')) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: label.name
                  });
                }
              }
            } catch (e) {
              console.log('No existing labels to remove');
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [sizeLabel]
            });
